# Ansible Deployment Guide

This guide explains how to use the Ansible playbooks to deploy and configure K3s on your infrastructure.

## Directory Structure

```
ansible/
├── inventory/          # Inventory files
│   ├── hosts.ini       # Node inventory (generated by Terraform)
│   └── group_vars/     # Group-specific variables
│       └── all.yml     # Variables for all nodes
├── playbooks/          # Playbook definitions
│   ├── site.yml        # Main playbook
│   ├── k3s_install.yml # K3s installation
│   ├── apps_deploy.yml # Application deployment
│   ├── k3s_reset.yml   # Cluster reset
│   └── test.yml        # Connectivity testing
├── roles/              # Role definitions
│   ├── common/         # Common node configuration
│   │   ├── defaults/   # Default variables
│   │   ├── tasks/      # Tasks to execute
│   │   └── templates/  # Templates for configuration files
│   ├── k3s_master/     # K3s server setup
│   │   ├── defaults/   # Default variables
│   │   ├── tasks/      # Tasks to execute
│   │   └── templates/  # Templates for configuration files
│   ├── k3s_worker/     # K3s agent setup
│   │   ├── tasks/      # Tasks to execute
│   │   └── templates/  # Templates for configuration files
│   └── kubernetes_apps/# Kubernetes applications
│       ├── defaults/   # Default variables
│       ├── tasks/      # Tasks to execute
│       └── templates/  # Templates for configuration files
└── ansible.cfg         # Ansible configuration file
```

## Configuration

### ansible.cfg

The `ansible.cfg` file contains settings for Ansible execution:

```ini
[defaults]
inventory = ./inventory/hosts.ini
remote_user = sanjin
host_key_checking = False
stdout_callback = yaml
roles_path = ./roles
timeout = 30
deprecation_warnings = False
private_key_file = ~/.ssh/k3s_id_ed25519
interpreter_python = auto_silent

[ssh_connection]
pipelining = True
ssh_args = -o ControlMaster=auto -o ControlPersist=30m -o ConnectionAttempts=100 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no
```

### Inventory

The inventory file `hosts.ini` is automatically generated by Terraform and contains your server and worker node information:

```ini
[master]
k3s-srv-1 ansible_host=10.0.0.6 ansible_user=sanjin ansible_ssh_private_key_file=~/.ssh/k3s_id_ed25519

[workers]
k3s-wkr-1 ansible_host=10.0.0.7 ansible_user=sanjin ansible_ssh_private_key_file=~/.ssh/k3s_id_ed25519
k3s-wkr-2 ansible_host=10.0.0.8 ansible_user=sanjin ansible_ssh_private_key_file=~/.ssh/k3s_id_ed25519

[k3s_cluster:children]
master
workers
```

### Global Variables

The inventory/group_vars/all.yml file contains cluster-wide settings:

```yaml
# K3s Version
k3s_version: v1.31.7+k3s1
k3s_channel: stable

# Networking
k3s_apiserver_host: "{{ hostvars[groups['master'][0]].ansible_host }}"
k3s_apiserver_port: 6443
k3s_flannel_backend: 'vxlan'
k3s_cluster_cidr: '10.42.0.0/16'
k3s_service_cidr: '10.43.0.0/16'
k3s_cluster_dns: '10.43.0.10'
k3s_cluster_domain: 'cluster.local'

# Components to disable
k3s_disable:
  - traefik
  - servicelb
```

## Deployment Process

### 1. Test Connectivity

Before starting the deployment, test connectivity to your nodes:

```sh
cd ansible
ansible-playbook playbooks/test.yml
```

### 2. Deploy K3s Cluster

Deploy the K3s cluster with:

```sh
ansible-playbook playbooks/site.yml
```

This runs:

- The common role on all nodes to prepare the system
- The k3s_master role on master nodes to install K3s server
- The k3s_worker role on worker nodes to install K3s agent
- The kubernetes_apps role to deploy core applications

### 3. Deploy Only Applications

To deploy or update just the applications:

```sh
ansible-playbook playbooks/apps_deploy.yml
```

### 4. Reset Cluster

To completely remove K3s from all nodes:

```sh
ansible-playbook playbooks/k3s_reset.yml
```

## Roles

### common

The common role prepares all nodes with:

- Basic packages installation
- Swap disabling (required for Kubernetes)
- Sysctl parameter configuration
- Firewall setup

### k3s_master

The k3s_master role:

- Installs K3s server on master nodes
- Configures high availability (if multiple masters)
- Sets up kubectl configuration

### k3s_worker

The k3s_worker role:

- Installs K3s agent on worker nodes
- Connects workers to the master

### kubernetes_apps

The kubernetes_apps role deploys core applications:

- Helm package manager
- MetalLB load balancer
- Traefik ingress controller
- Storage solutions (optional Longhorn)
- Monitoring stack (optional Prometheus/Grafana)

## Configuration Options

### K3s Version

To change the K3s version, modify `k3s_version` in `inventory/group_vars/all.yml`.

### High Availability

For HA setup, add multiple nodes to the master group in the inventory and set:

```yaml
k3s_ha_mode: true
```

### Application Customization

Modify `roles/kubernetes_apps/defaults/main.yml` to enable/disable components:

```yaml
# Enable/disable components
deploy_monitoring: true
deploy_longhorn: true
deploy_ingress: true
deploy_metallb: true

# Configure ingress
ingress_controller: 'traefik'

# Load balancer IP range
metallb_ip_range: '10.0.0.200-10.0.0.250'
```

## Troubleshooting

### SSH Connection Issues

If you encounter SSH connection errors:

- Verify hosts are reachable (ping test)
- Check the SSH key path in `ansible.cfg`
- Verify the `remote_user` matches the user on the VMs

### K3s Installation Failures

If K3s fails to install:

- Check system requirements (RAM, CPU)
- Ensure swap is disabled
- Check network connectivity between nodes
- Verify firewall settings allow required ports

### Application Deployment Issues

For application deployment problems:

- Check Helm is installed correctly
- Verify node status with `kubectl get nodes`
- Check pod status with `kubectl get pods --all-namespaces`
- Examine logs with `kubectl logs -n <namespace> <pod-name>`

## Advanced Usage

### Using Tags

Tags allow you to run specific parts of the playbooks:

```sh
# Install only K3s
ansible-playbook playbooks/site.yml --tags k3s

# Deploy only ingress
ansible-playbook playbooks/apps_deploy.yml --tags ingress

# Deploy only monitoring
ansible-playbook playbooks/apps_deploy.yml --tags monitoring
```

### Running on a Subset of Hosts

You can limit execution to specific hosts or groups:

```sh
# Only on worker nodes
ansible-playbook playbooks/site.yml --limit workers

# Only on a specific node
ansible-playbook playbooks/site.yml --limit k3s-wkr-1

# Skip application deployment
ansible-playbook playbooks/site.yml --skip-tags apps
```

### Checking Playbook Execution

To see what would be executed without making changes:

```sh
ansible-playbook playbooks/site.yml --check
```

## Security Considerations

### SSH Keys

Ensure your SSH keys are properly secured:

- Private key permissions should be 600
- Public key permissions should be 644

### Kubernetes Access

The `k3s_copy_kubeconfig_to_local` variable controls whether the kubeconfig is copied to your local machine:

```yaml
k3s_copy_kubeconfig_to_local: true
```

Keep the copied kubeconfig secure as it contains credentials for cluster access.

### Certificate Management

For production use, consider configuring proper certificates:

```yaml
# In group_vars/all.yml
k3s_tls_san:
  - 'cluster.example.com'
  - '10.0.0.6'
```

This ensures the API server certificate includes all necessary hostnames and IPs.

## Role Dependencies

Understanding the dependencies between roles is important:

- `common` role has no dependencies but is required by all other roles
- `k3s_master` depends on `common` being run first
- `k3s_worker` depends on both `common` and at least one `k3s_master` node being ready
- `kubernetes_apps` depends on a functioning K3s cluster (both roles above)

## Customizing the Deployment

### Custom K3s Configuration

To apply custom K3s configuration, add parameters to the `k3s_server_command` variable in `roles/k3s_master/tasks/install_first_master.yml`:

```yaml
k3s_server_command: >-
  INSTALL_K3S_VERSION={{ k3s_version }}
  /tmp/k3s-install.sh server
  --your-custom-parameter=value
```

### Adding New Applications

To add custom applications to the deployment:

1. Create a new task file in `roles/kubernetes_apps/tasks/my_app.yml`
2. Add your deployment logic using Helm or direct Kubernetes manifests
3. Include this task in `main.yml` with appropriate tagging:

```yaml
- name: Deploy my application
  ansible.builtin.include_tasks: my_app.yml
  tags: [my_app]
  when: deploy_my_app | bool
```

## Version Compatibility

This Ansible deployment has been tested with:

- K3s versions: v1.25.x through v1.31.x
- Ansible: 2.10+
- Kubernetes Python module: 12.0.0+
- Helm versions: v3.10+ (automated install of v3.14.3)

## Development Guidelines

When contributing to this project:

- Use YAML files with `.yml` extension (not `.yaml`)
- Follow the existing role and directory structure
- Add appropriate tagging to new tasks
- Document new variables in role defaults
- Include proper error handling and validation

## Next Steps After Deployment

Once your cluster is deployed:

1. Access the Kubernetes dashboard (if enabled)
2. Configure persistent storage for applications
3. Set up ingress rules for your services
4. Configure monitoring alerts
5. Implement backup and restore procedures
