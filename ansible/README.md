# K3s Ansible Deployment

This directory contains Ansible playbooks and roles for deploying K3s on the infrastructure provisioned by Terraform.

## Usage

1. Ensure Terraform has finished provisioning the infrastructure
2. Run the main playbook:

```bash
ansible-playbook playbooks/site.yml
```

## Structure

- `inventory/`: Ansible inventory and group variables
  - `hosts.ini`: Node definitions (generated by Terraform)
  - `group_vars/all.yml`: Global variables for all nodes
- `playbooks/`: Main playbooks for different operations
  - `site.yml`: Main deployment playbook
  - `k3s_install.yml`: Just installs K3s components
  - `apps_deploy.yml`: Deploys core applications
  - `k3s_reset.yml`: Uninstalls K3s for redeployment
  - `test.yml`: Tests connectivity to nodes
- `roles/`: Ansible roles for different components
  - `common/`: Basic system preparation tasks
  - `k3s_master/`: K3s server installation and configuration
  - `k3s_worker/`: K3s agent installation and configuration
  - `kubernetes_apps/`: Core Kubernetes applications

## Quick Commands

### Test Connectivity

```bash
ansible-playbook playbooks/test.yml
```

### Full Deployment

```bash
ansible-playbook playbooks/site.yml
```

### Deploy Only Applications

```bash
ansible-playbook playbooks/apps_deploy.yml
```

### Reset Cluster

```bash
ansible-playbook playbooks/k3s_reset.yml
```

## Customization

The deployment can be customized by modifying variables in:

- `inventory/group_vars/all.yml`: Cluster-wide settings
- `roles/*/defaults/main.yml`: Role-specific default variables

## Tags

You can use tags to run specific parts of the playbooks:

```bash
# Install only K3s
ansible-playbook playbooks/site.yml --tags k3s

# Deploy only specific applications
ansible-playbook playbooks/apps_deploy.yml --tags ingress,monitoring

# Skip certain components
ansible-playbook playbooks/site.yml --skip-tags apps
```

## Accessing the Cluster

After deployment, a kubeconfig file will be created in the root directory. Use it to access your cluster:

```bash
export KUBECONFIG=$(pwd)/../kubeconfig
kubectl get nodes
```

## Troubleshooting

If you encounter issues, please check:

1. Connectivity between nodes (use `test.yml` playbook)
2. System requirements (RAM, CPU, swap disabled)
3. Logs in `/var/log/syslog` and `journalctl -u k3s*`
4. The [troubleshooting guide](../docs/troubleshooting.md)
